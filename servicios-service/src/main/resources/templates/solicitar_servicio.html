<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>Formulario de Pedido</title>
    <link rel="stylesheet" th:href="@{/css/styleAdmin.css}" />

    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            background: #f7f8fb;
            color: #333;
        }

        h1 {
            text-align: center;
            padding: 20px;
            color: #464646;
        }

        .pedido-container {
            display: flex;
            gap: 25px;
            margin: 20px;
        }

        .col {
            flex: 1;
            background: #2a2a40;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            color: #fff;
        }

        .col h2,
        .col h3 {
            margin-top: 0;
            color: #edc73e;
        }

        .col p {
            margin: 5px 0;
        }

        .direccion-form,
        .pedido-section form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        label {
            font-weight: bold;
            margin-bottom: 4px;
        }

        input,
        select,
        textarea {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #1e1e2f;
            color: #fff;
            font-size: 14px;
            appearance: none; /* quitar estilo nativo */
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        /* Estilo del select desplegado */
        select:focus {
            border-color: #edc73e;
            outline: none;
            box-shadow: 0 0 5px #edc73e;
        }

        select option {
            background: #2a2a40;
            color: #fff;
        }

        button,
        .btn-azul {
            padding: 12px;
            border: none;
            background: #edc73e;
            color: #1e1e2f;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover,
        .btn-azul:hover {
            background: #d4b63a;
        }

        .divider {
            text-align: center;
            margin: 15px 0;
            font-weight: bold;
            color: #ccc;
        }

        textarea {
            min-height: 80px;
        }

        .servicio-info img {
            border-radius: 8px;
            margin-bottom: 15px;
            width: 100%;
            max-width: 280px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .mensaje {
            background: #28a745;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        /* Texto aclaratorio de precio */
        .precio-aclaracion {
            font-size: 13px;
            color: #ccc;
            margin-top: -5px;
            margin-bottom: 10px;
        }

        .descripcion-servicio {
            margin: 10px 0 15px;
            font-size: 14px;
            color: #eee;
        }
    </style>
</head>

<body>

    <header th:replace="components/menu_cliente"></header>

    <h1>Solicitar Servicio</h1>

    <div class="pedido-container">

        <!-- COLUMNA 1: Servicio -->
        <div class="col servicio-info">
            <img th:src="${servicio.imagen}" th:alt="${servicio.titulo}" />
            <h2 th:text="${servicio.titulo}"></h2>
            <p class="descripcion-servicio" th:text="${servicio.descripcionCompleta}"></p>
            <p><strong>Categoría:</strong> <span th:text="${servicio.categoria}"></span></p>
            <p><strong>Precio por hora:</strong> S/ <span th:text="${servicio.precioEstimado}"></span></p>
            <p class="precio-aclaracion">*El precio mostrado es por hora y se multiplicará por las horas de servicio seleccionadas.</p>
            <p><strong>Contacto:</strong> <span th:text="${servicio.telefonoContacto}"></span></p>
        </div>

        <!-- COLUMNA 2: Direcciones -->
        <div class="col">
            <h3>Dirección de atención</h3>
            <div id="direccionContainer">
                <div id="formulariosDireccion">
                    <form id="formSelect" th:action="@{/direccion/seleccionar}" method="post" class="direccion-form">
                        <input type="hidden" name="servicioId" th:value="${servicio.id}">
                        <label for="idDireccion">Seleccionar dirección existente:</label>
                        <select name="idDireccion" id="idDireccion" required>
                            <option value="">-- Seleccionar --</option>
                            <option th:each="dir : ${direcciones}" th:value="${dir.direccionID}"
                                th:text="${dir.direccion + ' (' + dir.distrito.nomb_Distrito + ')'}">
                            </option>
                        </select>
                        <button type="submit" class="btn-azul">Usar dirección</button>
                    </form>

                    <div class="divider">O agrega una nueva</div>

                    <form id="formAdd" th:action="@{/direccion/agregar}" method="post" class="direccion-form">
                        <input type="hidden" name="servicioId" th:value="${servicio.id}">
                        <label for="direccionCompleta">Dirección completa:</label>
                        <input type="text" id="direccionCompleta" name="direccionCompleta" required>

                        <label for="referencia">Referencia:</label>
                        <input type="text" id="referencia" name="referencia">

                        <label for="idDistrito">Distrito:</label>
                        <select id="idDistrito" name="idDistrito" required onchange="actualizarNombreDistrito()">
                            <option value="">-- Seleccionar distrito --</option>
                            <option th:each="dist : ${distritos}" th:value="${dist.distritoID}"
                                th:text="${dist.nomb_Distrito}">
                            </option>
                        </select>

                        <input type="hidden" id="distritoNombre" name="distritoNombre">
                        <button type="submit" class="btn-azul">Agregar dirección</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- COLUMNA 3: Pedido -->
        <div class="col pedido-section">
            <h3>Datos del pedido</h3>
            <form th:action="@{/pedidos/guardar}" method="post">
                <input type="hidden" name="servicioId" th:value="${servicio.id}" />

                <label for="fechaServicio">Día de inicio:</label>
                <input type="date" id="fechaServicio" name="fechaServicio" required />

                <label for="horaServicio">Hora de inicio:</label>
                <select id="horaServicio" name="horaServicio" required>
                    <option value="">-- Seleccionar hora --</option>
                </select>

                <label>Días de atención:</label>
                <input type="number" name="diasServicio" min="1" required />

                <label>Horas de servicio:</label>
                <input type="number" name="horasServicio" min="1" required />

                <label>Observaciones:</label>
                <textarea name="observaciones"></textarea>

                <button type="submit">Confirmar Pedido</button>
            </form>
        </div>

    </div>

</body>
<script>
    (function cargarHoras() {
        const select = document.getElementById('horaServicio');
        const inicio = 8;
        const fin = 21;

        for (let h = inicio; h <= fin; h++) {
            ['00', '30'].forEach(m => {
                const label = `${String(h).padStart(2, '0')}:${m}`;
                const opt = document.createElement('option');
                opt.value = label;
                opt.textContent = label;
                select.appendChild(opt);
            });
        }
    })();

    document.addEventListener('DOMContentLoaded', () => {
        const formSelect = document.getElementById('formSelect');
        const formAdd = document.getElementById('formAdd');
        const contenedor = document.getElementById('direccionContainer');
        const formularios = document.getElementById('formulariosDireccion');

        function mostrarDireccion(texto, mensaje) {
            formularios.style.display = 'none';
            contenedor.innerHTML = `
                    <div class="mensaje">
                        <span>${mensaje}</span>
                        <p><strong>${texto}</strong></p>
                        <button class="btn-azul" id="cambiarDireccion">Cambiar dirección</button>
                    </div>
                `;
            document.getElementById('cambiarDireccion').addEventListener('click', () => {
                contenedor.innerHTML = '';
                contenedor.appendChild(formularios);
                formularios.style.display = 'block';
            });
        }

        function actualizarNombreDistrito() {
            const select = document.getElementById('idDistrito');
            const nombre = select.options[select.selectedIndex].text;
            document.getElementById('distritoNombre').value = nombre;
        }

        formSelect.addEventListener('submit', async e => {
            e.preventDefault();
            const formData = new FormData(formSelect);
            const response = await fetch(formSelect.action, { method: 'POST', body: formData });
            const data = await response.json();
            if (data.success) {
                const select = document.getElementById('idDireccion');
                const textoSeleccionado = select.options[select.selectedIndex].text;
                mostrarDireccion(textoSeleccionado, "Dirección seleccionada correctamente");
            }
        });

        formAdd.addEventListener('submit', async e => {
            e.preventDefault();
            actualizarNombreDistrito();
            const formData = new FormData(formAdd);
            const response = await fetch(formAdd.action, { method: 'POST', body: formData });
            const data = await response.json();
            if (data.success) {
                const texto = `${data.direccion.direccion} (${data.direccion.distritoNombre})`;
                mostrarDireccion(texto, "Dirección registrada correctamente");

                const select = document.getElementById('idDireccion');
                const opt = document.createElement('option');
                opt.value = data.direccion.direccionID;
                opt.textContent = texto;
                select.appendChild(opt);

                formAdd.reset();
            }
        });
    });
</script>
</html>
